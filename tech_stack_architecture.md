# FilmLab 技术栈与架构说明

## 1. 技术栈
### 1.1 前端
- **框架**：React + TypeScript，用于多面板编辑器与批处理工作流的交互构建。
- **状态管理**：Zustand，集中管理项目状态、编辑栈、推荐结果与导出队列。
- **UI 组件**：
  - shadcn/ui（基于 Base UI 的组件版本）作为基础交互组件库。
  - Tailwind CSS 负责样式系统与快速布局。
- **渲染与性能**：
  - Canvas / WebGL（LUT、曲线、颗粒、暗角等 GPU 处理），保障拖动滑杆的实时预览体验。
  - Web Workers / OffscreenCanvas 分担缩略图生成、AI 体检与离屏渲染任务。

### 1.2 图像处理与 AI
- **图像处理内核**：
  - 预览：WebGL shader 实现 LUT/曲线/颗粒等效果。
  - 导出：离屏渲染 + 任务队列调度。
- **AI 体检与推荐**：
  - V1：规则引擎（基于直方图、曝光/色偏/噪点等特征）生成评分、Top3 preset 与解释。
  - V2：可接轻量分类模型或云端模型进行场景识别与更自然的教练话术。

### 1.3 数据存储
- **本地持久化**：IndexedDB 存储项目、缩略图、编辑参数与预设。
- **缓存策略**：最近项目列表 + 快照恢复。

### 1.4 工程与工具链
- **构建**：Vite + TypeScript。
- **质量保障**：ESLint + Prettier + Vitest（逻辑单元测试）。
- **资源管理**：LUT/曲线/预设 JSON 配置文件管理。

## 2. 总体架构
### 2.1 架构分层
1. **表现层（UI Layer）**
   - Landing、Library、AI Batch Studio、Editor、Export 等页面。
   - 统一组件体系（shadcn/ui + Tailwind CSS），支持分屏、对比、滑杆等高交互组件。
2. **状态与业务层（State/Domain Layer）**
   - Zustand store 管理项目、照片资产、编辑栈、推荐策略、批处理状态。
   - Command + Snapshot 机制管理撤销/重做与快照。
3. **图像处理层（Image Pipeline）**
   - 预览渲染：WebGL shader 实时管线。
   - 导出渲染：OffscreenCanvas + Worker 队列。
4. **AI 分析层（Analysis & Recommendation）**
   - 体检：直方图、曝光/色偏/噪点/锐度分析。
   - 推荐：规则引擎或轻量模型输出 Top3 preset + 解释。
5. **存储层（Persistence）**
   - IndexedDB 保存项目、缩略图与参数栈。

### 2.2 核心模块
1. **导入与资产管理**
   - 文件拖拽/多选导入 → 生成缩略图 → 读取 EXIF → 写入 IndexedDB。
2. **非破坏式编辑引擎**
   - 参数化滤镜栈：LUT、曲线、颗粒、暗角等参数可序列化。
   - Command 模式支持撤销/重做与快照。
3. **AI 体检与推荐**
   - 体检：直方图、曝光/色偏/噪点/锐度等指标。
   - 推荐：Top3 preset + 置信度 + 可解释原因。
4. **AI Batch Studio（批处理面板）**
   - 自动分组（按场景/光线特征）。
   - 一键组内应用 preset / 强度统一调节 / 组内替换。
5. **单张编辑器**
   - Before/After 对比、分屏、滑杆调节。
   - 编辑参数实时预览。
6. **导出与队列**
   - 队列任务 + 可取消/失败重试。
   - 支持格式、尺寸、质量、EXIF 保留。

### 2.3 数据流（简化）
1. **导入**：文件 → 资产管理 → 缩略图生成 → IndexedDB。
2. **体检**：图像特征分析 → 体检报告 → 推荐引擎 → 生成 Top3 preset。
3. **批处理**：分组 → 组内 preset 应用 → 生成初步编辑参数。
4. **精修**：编辑器调整 → 更新滤镜栈 → 快照/撤销记录。
5. **导出**：渲染管线（GPU 或离屏）→ 输出文件。

### 2.4 关键性能策略
- **预览渲染与导出分离**：预览用低分辨率纹理，导出用全分辨率离屏渲染。
- **任务队列**：缩略图生成、AI 分析、导出全部排队、可取消。
- **缓存与持久化**：IndexedDB 保持项目状态，支持崩溃恢复。

## 3. 架构与需求映射
- **批处理效率**：Batch Studio + 组内统一应用机制满足 50 张快速出片需求。
- **可解释性**：体检报告 + 推荐原因/风险提示。
- **胶片质感**：LUT + 曲线 + 颗粒 + 暗角为基础，预留 halation/bloom 扩展。
- **非破坏式编辑**：参数化滤镜栈 + 撤销/快照满足可回退与可控需求。
- **稳定性与隐私**：本地优先处理，AI 失败降级不中断编辑。
