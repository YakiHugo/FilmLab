# 预设系统缺口清单（Film Pipeline）

## 当前状态（压缩版）
- 已有解耦模块：`colorScience / tone / scan / grain / defects`
- 已有数据结构：`Preset` + `FilmProfile` + `filmOverrides`
- 已有渲染链路：`WebGL2` 优先，失败回退 CPU
- 已有基础能力：预设导入导出、胶片档案导入导出、编辑页调参、导出页应用

## P0（优先做）
1. 真正 LUT 色彩科学
- 现状：`colorScience` 还是参数化近似，不是标准 LUT 管线。
- 缺口：缺 3D LUT（或 2D LUT 映射 3D）采样、强度混合、LUT 资产管理。

2. 随机种子完整闭环
- 现状：有 `seedMode`，但产品能力不完整。
- 缺口：缺“锁定/刷新 seed”UI、seed 持久化策略、预览和导出一致性规则。

3. 高分辨率导出性能
- 现状：主线程渲染，移动端大图风险高。
- 缺口：缺 Worker/OffscreenCanvas 分流、导出进度、失败重试与降级策略。

4. 结果一致性验证
- 现状：缺自动化验证。
- 缺口：缺“同参数同结果”“不同 seed 有差异”“WebGL 与 CPU 偏差阈值”的测试。

## P1（第二阶段）
1. 贴图型瑕疵系统
- 现状：漏光/灰尘/划痕主要是程序化。
- 缺口：缺贴图素材包（overlay）、混合模式、随机位置/缩放/旋转、强度分层。

2. 配方版本化与迁移
- 现状：有 profile 结构，但升级策略不完整。
- 缺口：缺 schema version、migrate pipeline、旧版本兼容策略。

3. 更完整影调能力
- 现状：曲线能力简化。
- 缺口：缺点曲线、分通道曲线、胶片响应曲线（S-curve）模板。

## P2（体验与产品化）
1. 预设生态能力
- 缺口：预设包签名/来源标识、分类检索、冲突处理、封面预览缓存。

2. i18n 文案治理
- 现状：文案中英混用。
- 缺口：统一 i18n 资源文件，避免硬编码字符串散落。

3. 指标监控
- 缺口：渲染耗时、导出成功率、机型兼容统计、预设使用分布。

## 建议落地顺序
1. P0-1 LUT 管线
2. P0-2 种子闭环
3. P0-3 导出性能
4. P0-4 一致性测试
5. P1-1 贴图瑕疵

## P0 实施进展（2026-02-08）

### 已完成
1. LUT 管线（P0-1）
- 新增 `.cube` 3D LUT 解析、LUT 资产注册与 IndexedDB 缓存。
- CPU 渲染支持 LUT 三线性采样，WebGL2 渲染支持 3D 纹理采样。
- `colorScience` 支持 LUT 路径与旧算法回退，默认由 feature flag 控制。

2. 种子闭环（P0-2）
- 增加 `seedSalt` 持久化字段（Asset 级），并接入预览与导出链路。
- 统一 seed 规则：`perAsset / perRender / perExport / locked`。
- 编辑页增加 seed 控件（锁定、刷新、seedMode），由 feature flag 控制。

3. 导出性能与降级（P0-3）
- 增加 Worker + OffscreenCanvas 导出路径与主线程降级路径。
- 导出任务支持状态流转（处理中/重试中/完成/失败）与进度更新。
- 增加失败重试策略（优先 worker，失败后自动降级）。
- 修复批量导出重复保存弹窗：工作台导出统一打包为单个 ZIP 下载；导出页支持目录/ZIP 单次交付。

4. 一致性测试（P0-4）
- 引入 Vitest 测试体系。
- 已落地测试：LUT 解析/采样、seed 稳定性、像素 MAE 阈值工具与基础用例。
- 当前阈值基线：`MAE <= 2/255`。

### 待完善（P0 余项）
1. 补充 WebGL 与 CPU 在真实图像样本上的自动化对比基线（当前为基础单元测试）。
2. 增加导出链路的自动化集成测试（worker 不可用、降级与重试分支）。
3. 将 feature flag 策略沉淀到统一配置文档并补充调试指引。
