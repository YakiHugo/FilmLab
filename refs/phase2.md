Phase 2：功能填充

Phase 2 基于 Phase 1 的骨架，将四个模块从"可导航的骨架"提升到"可用的产品"。分为 5
个工作流，按依赖关系排序。

---

2A. Bug 修复 + 关键 UX（阻塞性问题，最先做）

#: 1
问题: ChatInput Enter 键不提交
文件: src/features/chat/ChatInput.tsx
修复方案: 添加 onKeyDown：Enter 提交，Shift+Enter 换行
────────────────────────────────────────
#: 2
问题: Canvas Transformer 不持久化 resize/rotate
文件: src/features/canvas/CanvasViewport.tsx
修复方案: 添加 onTransformEnd 回调，读取 node 的 scaleX/scaleY/rotation，计算新
width/height，调用 upsertElement
────────────────────────────────────────
#: 3
问题: Canvas store init() 未被调用
文件: src/features/canvas/CanvasPage.tsx
修复方案: 添加 useEffect(() => { canvasStore.init() }, [])
────────────────────────────────────────
#: 4
问题: useChatSession 切换会话时的竞态
文件: src/features/chat/hooks/useChatSession.ts
修复方案: 切换时先 clearTimeout(saveTimerRef)，用 activeConversationId ref 而非闭包值做 save

守卫
────────────────────────────────────────
#: 5
问题: toolResults 跨会话未清除
文件: src/features/chat/hooks/useChatSession.ts
修复方案: 切换 activeConversationId 时 setToolResults([])
────────────────────────────────────────
#: 6
问题: AI 看不到工具执行结果
文件: api/ai-chat.ts + useChatTools.ts
修复方案: 服务端工具 execute 改为 async 并等待客户端结果（或改为客户端 tool execution  
 模式，让 useChat 的 onToolCall 处理）
────────────────────────────────────────
#: 7
问题: ShapeElement line 拖拽坐标脱同步
文件: src/features/canvas/elements/ShapeElement.tsx
修复方案: onDragEnd 时更新 points 相对于新 position 的偏移
────────────────────────────────────────
#: 8
问题: ImageElement blob URL 内存泄漏
文件: src/features/canvas/elements/ImageElement.tsx
修复方案: useEffect cleanup 中 img.src = "" 并 revoke blob URL

---

2B. 画布模块完善（最大的功能缺口）

分 4 个子步骤，每步可独立验证：

2B-1. 核心交互

┌────────────┬──────────────────────────┬───────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├────────────┼──────────────────────────┼───────────────────────────────────────────────┤  
 │ │ │ Stage 上 onWheel 实现 scroll-to-zoom（更新 │  
 │ 缩放/平移 │ CanvasViewport.tsx │ store zoom），按住空格或选择 Hand │  
 │ │ │ 工具时拖拽平移（更新 Stage position） │  
 ├────────────┼──────────────────────────┼───────────────────────────────────────────────┤  
 │ 多选 │ CanvasViewport.tsx, │ Shift+click 追加选择；Transformer 绑定多个 │  
 │ │ useCanvasInteraction.ts │ nodes │  
 ├────────────┼──────────────────────────┼───────────────────────────────────────────────┤  
 │ │ │ Delete 删除选中元素，Ctrl+C/V │  
 │ 键盘快捷键 │ useCanvasInteraction.ts │ 复制粘贴，方向键微调位置（1px，Shift+方向 │  
 │ │ │ 10px），Ctrl+A 全选 │  
 ├────────────┼──────────────────────────┼───────────────────────────────────────────────┤  
 │ 元素删除 │ canvasStore.ts │ 新增 deleteElements(ids: string[]) 方法，从 │  
 │ │ │ document.elements 中移除并持久化 │  
 ├────────────┼──────────────────────────┼───────────────────────────────────────────────┤  
 │ 元素复制 │ canvasStore.ts, │ 新增 duplicateElements(ids: string[])，生成新 │  
 │ │ useCanvasInteraction.ts │ ID + 偏移位置 │  
 └────────────┴──────────────────────────┴───────────────────────────────────────────────┘

2B-2. 图层面板

┌────────────┬──────────────────────┬────────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ 拖拽排序 │ CanvasLayerPanel.tsx │ 拖拽改变 zIndex 顺序，调用 │  
 │ │ │ canvasStore.reorderElements() │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ 可见性切换 │ CanvasLayerPanel.tsx │ 眼睛图标切换 element.visible │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ 锁定切换 │ CanvasLayerPanel.tsx │ 锁图标切换 element.locked（锁定后不可拖拽/选中） │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ 删除图层 │ CanvasLayerPanel.tsx │ 每层的删除按钮 │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ 缩略图预览 │ CanvasLayerPanel.tsx │ 图片元素显示小缩略图，文本显示文字预览 │  
 ├────────────┼──────────────────────┼────────────────────────────────────────────────────┤  
 │ Store 方法 │ canvasStore.ts │ 新增 reorderElements, toggleElementVisibility, │  
 │ │ │ toggleElementLock │  
 └────────────┴──────────────────────┴────────────────────────────────────────────────────┘

2B-3. 属性面板 + 元素创建

┌────────────┬───────────────────────┬─────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├────────────┼───────────────────────┼─────────────────────────────────────────────────┤  
 │ │ CanvasPropertiesPanel │ 输入框编辑 │  
 │ 可编辑属性 │ .tsx │ x/y/width/height/rotation/opacity，onChange │  
 │ │ │ 调用 upsertElement │  
 ├────────────┼───────────────────────┼─────────────────────────────────────────────────┤  
 │ 类型特定属 │ CanvasPropertiesPanel │ 图片：显示资产名 + filmProfileId 选择器；文本： │  
 │ 性 │ .tsx │ 字体/大小/颜色/对齐；形状：填充/描边/线宽 │  
 ├────────────┼───────────────────────┼─────────────────────────────────────────────────┤  
 │ │ │ Text 工具激活时，点击画布创建 │  
 │ 文本创建 │ CanvasViewport.tsx │ TextElement，双击进入内联编辑（HTML overlay │  
 │ │ │ textarea） │  
 ├────────────┼───────────────────────┼─────────────────────────────────────────────────┤  
 │ 形状创建 │ CanvasViewport.tsx, │ 添加 Shape 工具按钮（下拉选择 │  
 │ │ CanvasToolbar.tsx │ rect/circle/line），点击/拖拽画布创建 │  
 ├────────────┼───────────────────────┼─────────────────────────────────────────────────┤  
 │ 内联文本编 │ TextElement.tsx │ 双击触发 HTML textarea overlay，编辑完成后更新 │  
 │ 辑 │ │ element.content │  
 └────────────┴───────────────────────┴─────────────────────────────────────────────────┘

2B-4. Undo/Redo + 导出

┌────────────┬────────────────────────┬────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├────────────┼────────────────────────┼────────────────────────────────────────────────┤  
 │ Undo/Redo │ │ 快照式：每次 mutation 前保存 document.elements │  
 │ 实现 │ useCanvasHistory.ts │ 快照到 undo 栈（最大 50 步），redo │  
 │ │ │ 栈在新操作时清空 │  
 ├────────────┼────────────────────────┼────────────────────────────────────────────────┤  
 │ 集成到 │ │ 所有 mutation │  
 │ store │ canvasStore.ts │ 方法（upsert/delete/reorder/toggle）调用 │  
 │ │ │ history.pushSnapshot() │  
 ├────────────┼────────────────────────┼────────────────────────────────────────────────┤  
 │ 工具栏按钮 │ CanvasToolbar.tsx │ Undo/Redo 按钮 + Ctrl+Z/Ctrl+Shift+Z 快捷键 │  
 ├────────────┼────────────────────────┼────────────────────────────────────────────────┤  
 │ 多格式导出 │ useCanvasExport.ts │ 支持 PNG（已有）、JPEG（quality │  
 │ │ │ 参数）、自定义尺寸/DPI │  
 ├────────────┼────────────────────────┼────────────────────────────────────────────────┤  
 │ 导出对话框 │ 新建 │ 格式选择、尺寸设置、质量滑块、预览 │  
 │ │ CanvasExportDialog.tsx │ │  
 └────────────┴────────────────────────┴────────────────────────────────────────────────┘

---

2C. AI Chat 模块完善

2C-1. 聊天 UX

┌──────────────────┬────────────────┬──────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 自动滚动 │ ChatThread.tsx │ 新消息时 scrollIntoView({ behavior: "smooth" │  
 │ │ │ })，用 useEffect 监听 messages 长度变化 │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 流式指示器 │ ChatThread.tsx │ status === "streaming" │  
 │ │ │ 时在最后一条消息后显示打字动画（三个跳动的点） │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 工具调用内联渲染 │ ChatThread.tsx │ 解析 UIMessage.parts 中的 tool-invocation │  
 │ │ │ 类型，在消息流中内联渲染 ChatToolResultCard │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 停止生成按钮 │ ChatInput.tsx │ isLoading 时显示 Stop 按钮，调用 stop() │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ Textarea │ ChatInput.tsx │ 监听 input 变化，动态设置 style.height 基于 │  
 │ 自适应高度 │ │ scrollHeight，最大 200px │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 模型选择器 │ ChatPage.tsx │ 渲染 selectedModel/setSelectedModel，用 shadcn │  
 │ │ 或 Header.tsx │ Select 组件 │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 错误显示 │ ChatThread.tsx │ error 非空时在线程底部显示错误卡片 + 重试按钮 │  
 ├──────────────────┼────────────────┼──────────────────────────────────────────────────┤  
 │ 图片附件 │ ChatInput.tsx │ 添加图片上传按钮，附件预览条，发送时作为 │  
 │ │ │ multipart content │  
 └──────────────────┴────────────────┴──────────────────────────────────────────────────┘

2C-2. 工具结果增强

功能: 工具特定渲染
文件: ChatToolResultCard.tsx
说明: 按 toolName 分支渲染：selectAssets 显示匹配的资产缩略图网格；openInEditor 显示导航确认

- 资产预览；createCanvas 显示画布预览链接；generateImage 显示生成的图片
  ────────────────────────────────────────
  功能: 成功/失败状态
  文件: useChatTools.ts
  说明: dispatchTool 返回 { success: boolean, data?, error? }，结果传回 ChatToolResultCard  
  ────────────────────────────────────────
  功能: 结果反馈给 AI
  文件: useChatSession.ts
  说明: 使用 useChat 的 onToolCall 回调执行客户端工具，返回实际结果让 AI 知道操作是否成功

2C-3. 文生图集成

┌────────────────────┬─────────────────────────────┬────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ 连通 │ │ 替换 stub，实际调用 │  
 │ useImageGeneration │ hooks/useImageGeneration.ts │ src/lib/ai/imageGeneration.ts 的 │  
 │ │ │ fetch 函数 │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ │ │ 添加 generateImage handler，调用 │  
 │ Chat 工具分发 │ useChatTools.ts │ imageGeneration │  
 │ │ │ API，结果导入资产库 │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ │ │ 生成完成后，将图片 blob 通过 │  
 │ 保存到资产库 │ useImageGeneration.ts │ assetStore.importAssets() │  
 │ │ │ 导入，标记 source: "ai-generated" │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ │ │ "Add to Canvas" │  
 │ 添加到画布 │ ImageGenerationCard.tsx │ 按钮，将生成的图片作为 │  
 │ │ │ ImageElement 添加到当前画布 │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ │ │ 添加 prompt 输入框 + │  
 │ UI 触发入口 │ ImageGenerationCard.tsx │ provider/model 选择器 + Generate │  
 │ │ │ 按钮 │  
 ├────────────────────┼─────────────────────────────┼────────────────────────────────────┤  
 │ Stability AI 实现 │ api/image-generate.ts │ 完成 Stability AI provider 的 REST │  
 │ │ │ API 集成（当前返回 501） │  
 └────────────────────┴─────────────────────────────┴────────────────────────────────────┘

2C-4. 扩展工具集

┌─────────────────────┬──────────────┬─────────────────┬─────────────────────────────────┐  
 │ 工具 │ Schema 文件 │ Dispatch 文件 │ 说明 │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ applyPresetToAssets │ chatTools.ts │ useChatTools.ts │ 批量应用胶片预设到指定资产 │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ tagAssets │ chatTools.ts │ useChatTools.ts │ 批量添加/移除标签 │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ deleteAssets │ chatTools.ts │ useChatTools.ts │ 删除指定资产（需确认） │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ addTextToCanvas │ chatTools.ts │ useChatTools.ts │ 在画布上添加文本元素 │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ exportCanvas │ chatTools.ts │ useChatTools.ts │ 导出画布为图片 │  
 ├─────────────────────┼──────────────┼─────────────────┼─────────────────────────────────┤  
 │ describeAssets │ chatTools.ts │ useChatTools.ts │ 返回指定资产的元数据摘要，供 AI │  
 │ │ │ │ 做决策 │  
 └─────────────────────┴──────────────┴─────────────────┴─────────────────────────────────┘

同步更新：

- api/ai-chat.ts — 注册新工具的 schema
- src/lib/ai/chatPrompts.ts — 系统提示词中描述新工具的能力
- api/ai-chat.ts — maxSteps 从 2 提升到 5，支持更复杂的多步工具链

---

2D. 资产库增强

┌──────────┬────────────────┬──────────────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 虚拟滚动 │ AssetGrid.tsx │ 引入 @tanstack/react-virtual │  
 │ │ │ 实现虚拟化网格，支持数百张图片流畅滚动 │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 详情面板 │ AssetDetailPan │ 缩略图预览、可编辑标签（chip + 输入框）、EXIF │  
 │ 增强 │ el.tsx │ 元数据展示（相机/镜头/光圈/快门/ISO）、操作按钮（删除/在 │  
 │ │ │ 编辑器中打开） │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 筛选栏升 │ FilterBar.tsx │ 用 shadcn Select 替换原生 <select>；添加清除筛选按钮、排 │  
 │ 级 │ │ 序控制（按日期/名称/大小）、网格/列表视图切换 │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ Sidebar │ LibrarySidebar │ 日期和标签项可点击，点击后应用对应筛选条件到 │  
 │ 交互 │ .tsx │ useLibraryFilters │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 全选按钮 │ LibraryPage.ts │ 添加"全选/取消全选"按钮，调用 │  
 │ │ x │ useAssetSelection.toggleAll │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 删除确认 │ BatchActionsBa │ 批量删除前弹出 AlertDialog 确认 │  
 │ │ r.tsx │ │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 批量预设 │ BatchActionsBa │ 添加预设选择下拉 + "应用预设"按钮 │  
 │ 应用 │ r.tsx │ │  
 ├──────────┼────────────────┼──────────────────────────────────────────────────────────┤  
 │ 键盘多选 │ AssetGrid.tsx │ Shift+click 范围选择，Ctrl+click 切换单个 │  
 └──────────┴────────────────┴──────────────────────────────────────────────────────────┘

新增依赖：@tanstack/react-virtual

---

2E. AI 基础设施加固

┌─────────────┬───────────────────┬─────────────────────────────────────────────────────┐  
 │ 功能 │ 文件 │ 说明 │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 编辑器作用 │ chatPrompts.ts │ 新增 EDITOR_SYSTEM_PROMPT，包含当前图片的直方图分析 │  
 │ 域提示词 │ │ 、当前调整参数、可用胶片预设列表 │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 动态上下文 │ chatPrompts.ts │ 导出 buildHubPrompt(context) │  
 │ 注入 │ │ 函数，注入当前资产数量、选中资产信息、活跃画布状态 │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 请求体验证 │ api/ai-chat.ts │ content: z.any() 改为 z.union([z.string(), │
 │ 加固 │ │ z.array(z.object(...))]) │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 对话上下文 │ api/ai-chat.ts │ 当消息数超过阈值时，截断早期消息只保留最近 N 条 + │  
 │ 窗口 │ │ 系统消息 │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 客户端工具 │ │ 使用 useChat 的 onToolCall │  
 │ 执行模式 │ useChatSession.ts │ 回调在客户端执行工具，返回真实结果给 │  
 │ │ │ AI（替代当前服务端 "requested" 模式） │  
 ├─────────────┼───────────────────┼─────────────────────────────────────────────────────┤  
 │ 删除 projec │ src/stores/projec │ 确认无消费者后删除 │  
 │ tStore shim │ tStore.ts │ │  
 └─────────────┴───────────────────┴─────────────────────────────────────────────────────┘

---

Phase 2 实施顺序

2A (Bug 修复)
↓
2B-1 (画布核心交互) ←──── 2C-1 (聊天 UX) ←── 2D (资产库增强)
↓ ↓ [可并行]
2B-2 (图层面板) 2C-2 (工具结果增强)
↓ ↓
2B-3 (属性面板+元素创建) 2C-3 (文生图集成)
↓ ↓
2B-4 (Undo/Redo+导出) 2C-4 (扩展工具集)
↓
2E (AI 基础设施加固)

2A 最先做（阻塞性 bug）。之后 2B、2C、2D 三条线可并行推进。2E 在 2C 完成后做。

---

Phase 2 关键文件清单

操作: 修复
文件: ChatInput.tsx, CanvasViewport.tsx, CanvasPage.tsx, useChatSession.ts,
ShapeElement.tsx,
ImageElement.tsx, api/ai-chat.ts
────────────────────────────────────────
操作: 重写
文件: ChatThread.tsx（内联工具渲染）, ChatToolResultCard.tsx（工具特定 UI）,
CanvasPropertiesPanel.tsx（可编辑）, CanvasLayerPanel.tsx（完整交互）,
useCanvasHistory.ts（实际实现）, useImageGeneration.ts（连通 API）
────────────────────────────────────────
操作: 演进
文件: canvasStore.ts（+delete/reorder/toggle/history）, useChatTools.ts（+新工具+结果反馈）,

useCanvasInteraction.ts（+键盘+多选）, useCanvasExport.ts（+多格式）, chatTools.ts（+新  
 schema）, chatPrompts.ts（+动态上下文）, AssetGrid.tsx（+虚拟滚动）,
AssetDetailPanel.tsx（+完整信息）, FilterBar.tsx（+shadcn）, LibrarySidebar.tsx（+交互）,  
 BatchActionsBar.tsx（+确认+预设）
────────────────────────────────────────
操作: 新建
文件: CanvasExportDialog.tsx, ImageGenerationCard.tsx（重写为完整 UI）
────────────────────────────────────────
操作: 删除
文件: src/stores/projectStore.ts
────────────────────────────────────────
操作: 新增依赖
文件: @tanstack/react-virtual

---

Phase 2 验证方式

每个子步骤完成后运行 pnpm build && pnpm lint && pnpm test。

功能验证清单：

2A 完成后：

- Chat 中按 Enter 发送消息，Shift+Enter 换行
- Canvas 中用 Transformer 缩放/旋转元素后刷新页面，变换保持
- 切换 Chat 会话时工具结果清空，无消息闪烁

2B 完成后：

- 滚轮缩放画布，空格+拖拽平移
- Shift+click 多选元素，Delete 删除，Ctrl+C/V 复制粘贴
- 图层面板拖拽排序，眼睛/锁图标切换
- 属性面板输入数值直接修改元素
- Text 工具点击画布创建文本，双击编辑
- Shape 工具创建矩形/圆形/线条
- Ctrl+Z/Ctrl+Shift+Z 撤销/重做
- 导出对话框选择格式和尺寸

2C 完成后：

- 新消息自动滚动到底部，流式回复有打字动画
- 工具调用结果在消息流中内联显示（带缩略图/链接）
- AI 说"帮我选 5 张风景照"→ 资产库中对应图片被选中，Chat 显示结果
- AI 说"生成一张日落图片"→ 调用文生图 API → 图片显示在 Chat 中 → 可保存到资产库
- 模型选择器可切换 OpenAI/Anthropic/Google

2D 完成后：

- 导入 200+ 张图片后网格流畅滚动
- 详情面板显示 EXIF、可编辑标签
- Sidebar 点击日期/标签自动筛选
- 批量删除弹出确认对话框
